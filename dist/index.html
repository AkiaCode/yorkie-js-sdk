<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Codemirror Example</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.js"></script>
</head>
<body>
  <div>
    <textarea id="placeholder" cols="30" rows="10"></textarea>
    <div>document:</div>
    <pre style="white-space: pre-wrap;"><code id="log-holder"></code></pre>
    <div>text:</div>
    <pre style="white-space: pre-wrap;"><code id="text-log-holder"></code></pre>
  </div>
  <script src="./yorkie.js"></script>
  <script>
    const placeholder = document.getElementById('placeholder');
    const logHolder = document.getElementById('log-holder');
    const textLogHolder = document.getElementById('text-log-holder');

    function displayLog(doc) {
      logHolder.innerText = doc.toJSON();
      textLogHolder.innerText = doc.getRootObject().get('content').getAnnotatedString();
    }

    // https://github.com/codemirror/CodeMirror/pull/5619
    function replaceRangeFix(cm, text, from, to, origin) {
      const adjust = cm.listSelections().findIndex(({anchor, head}) => {
        return CodeMirror.cmpPos(anchor, head) === 0 && CodeMirror.cmpPos(anchor, from) === 0;
      });
      cm.operation(() => {
        cm.replaceRange(text, from, to, origin);
        if (adjust > -1) {
          const range = cm.listSelections()[adjust];
          if (range && CodeMirror.cmpPos(range.head, CodeMirror.changeEnd({from, to, text})) === 0) {
            const ranges = cm.listSelections().slice();
            ranges[adjust] = {anchor: from, head: from};
            cm.setSelections(ranges);
          }
        }
      });
    }

    async function main() {
      try {
        // 01. create client with RPCAddr(envoy) then activate it.
        const client = yorkie.createClient('/api');
        await client.activate();

        // 02. create a document then attach it into the client.
        const doc = yorkie.createDocument('examples', 'codemirror-1');
        await client.attachDocument(doc);
        doc.update((root) => {
          root.getOrCreateText('content');
        });
        await client.sync();

        // 03. create an instance of codemirror.
        const codemirror = CodeMirror.fromTextArea(placeholder, {
          lineNumbers: true
        });

        // 04. bind the document with the codemirror.
        // 04-1. codemirror to document(local).
        codemirror.on('beforeChange', (cm, change) => {
          if (change.origin === 'yorkie' || change.origin === 'setValue') {
            return;
          }

          const from = cm.indexFromPos(change.from);
          const to = cm.indexFromPos(change.to);
          const content = change.text.join('\n');

          doc.update((root) => {
            const text = root.getOrCreateText('content');
            text.edit(from, to, content);
          });

          displayLog(doc);
          console.log(`%c local: ${from}-${to}: ${content}`, 'color: green');
          client.sync();
        });

        // 04-2. document to codemirror(remote).
        const text = doc.getRootObject().get('content');
        text.onChanges((changes) => {
          for (const change of changes) {
            const actor = change.actor;
            const from = change.from;
            const to = change.to;
            const content = change.content || '';

            if (actor !== client.getID()) {
              console.log(`%c remote: ${from}-${to}: ${content}`, 'color: skyblue');
              const fromIdx = codemirror.posFromIndex(from);
              const toIdx = codemirror.posFromIndex(to);
              replaceRangeFix(codemirror, content, fromIdx, toIdx, 'yorkie');
            }
          }
        });

        // 05. set initial value.
        displayLog(doc);
        codemirror.setValue(text.getValue());
      } catch (e) {
        console.error(e);
      }
    }

    main();
  </script>
</body>
</html>
